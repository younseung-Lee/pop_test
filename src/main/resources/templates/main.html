<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POP 작업</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/template_delete.css}">
    <link rel="stylesheet" th:href="@{/css/product_search.css}">
</head>
<body th:attr="data-user-id=${user != null ? user.id : ''}">
<div class="header">
    <div class="header-left">
        <div class="logo">StoDay POP</div>
        <div class="header-buttons">
            <button class="header-btn" type="button" onclick="PopEditor.newWork()">📄 새 문서</button>
            <button class="header-btn" type="button" onclick="PopEditor.saveWork()">POP 저장</button>
            <!-- a4 관리자만 보이는 공통 템플릿 등록 버튼 -->
            <button class="header-btn"
                    type="button"
                    th:if="${user != null and user.id == 'a4'}"
                    onclick="location.href='/templates/common/new'">
                ➕ 공통 템플릿 등록
            </button>
        </div>
    </div>
    <div class="header-right">
        <div class="user-info-header">
            <span>👤 <span th:text="${user.nm}">admin</span>님</span>
        </div>
        <button class="logout-btn" type="button" onclick="logout()">로그아웃</button>
    </div>
</div>

<div class="toolbar">
    <div class="toolbar-section">
        <select class="toolbar-select" id="fontFamilySelect">
            <option value="Gmarket Sans">G마켓 산스 Bold</option>
            <option value="Nanum Gothic">나눔고딕</option>
            <option value="Malgun Gothic">맑은 고딕</option>
        </select>
        <select class="toolbar-select" id="fontSizeSelect">
            <option value="12">12</option>
            <option value="14">14</option>
            <option value="16">16</option>
            <option value="18">18</option>
            <option value="24">24</option>
            <option value="28">28</option>
            <option value="32">32</option>
            <option value="36" selected>36</option>
            <option value="48">48</option>
            <option value="60">60</option>
            <option value="72">72</option>
            <option value="96">96</option>
        </select>
        <button class="toolbar-btn" type="button" onclick="PopEditor.applyTextStyle()">폰트 적용</button>
    </div>
    <div class="toolbar-section">
        <button class="toolbar-btn" type="button"><strong>가</strong></button>
        <button class="toolbar-btn" type="button"><em>가</em></button>
        <button class="toolbar-btn" type="button"><u>가</u></button>
        <button class="toolbar-btn" type="button">가</button>
        <button class="toolbar-btn" type="button">가</button>
    </div>
    <div class="toolbar-section">
        <button class="toolbar-btn" type="button" onclick="PopEditor.addText()">📝 텍스트 추가</button>
        <button class="toolbar-btn" type="button" onclick="PopEditor.addShape('rectangle')">□ 사각형</button>
        <button class="toolbar-btn" type="button" onclick="PopEditor.addShape('circle')">○ 원형</button>
        <button class="toolbar-btn" type="button" onclick="PopEditor.addImage()">🖼️ 이미지불러오기</button>
    </div>
    <div class="toolbar-section">
        <label style="font-size: 14px; margin-right: 5px;">채우기:</label>
        <input type="color" id="fillColorPicker" value="#ffffff" style="width: 40px; height: 30px; border: 1px solid #ddd; cursor: pointer;">
        <label style="font-size: 14px; margin: 0 5px;">테두리:</label>
        <input type="color" id="strokeColorPicker" value="#000000" style="width: 40px; height: 30px; border: 1px solid #ddd; cursor: pointer;">
        <button class="toolbar-btn" type="button" onclick="PopEditor.applyColors()">색상 적용</button>
        <button class="toolbar-btn" type="button" onclick="PopEditor.removeColors()">색상 제거</button>
    </div>
    <div class="toolbar-section">
        <button class="toolbar-btn" type="button" onclick="PopEditor.deleteSelected()">삭제</button>
        <button class="toolbar-btn" type="button" onclick="PopEditor.bringForward()">앞으로</button>
        <button class="toolbar-btn" type="button" onclick="PopEditor.sendBackward()">뒤로</button>
    </div>
</div>

<!-- 숨김: 이미지 업로드 input -->
<input type="file" id="imageFileInput" accept="image/*" style="display:none;">

<div class="main-container">

    <!-- 왼쪽: 템플릿 / 상품검색 -->
    <aside class="left-sidebar">
        <div class="sidebar-tabs">
            <button class="sidebar-tab active" type="button" onclick="toggleSidebarTab('template')">📑 템플릿</button>
            <button class="sidebar-tab" type="button" onclick="toggleSidebarTab('product')">🔍 상품 이미지검색</button>
        </div>

        <!-- 상품 이미지 검색 영역 -->
        <div class="product-search-container" id="productSearchContainer">
            <div class="product-search-box">
                <div class="search-input-group">
                    <select class="search-type-select" id="productSearchType">
                        <option value="NAME">상품명</option>
                        <option value="CODE">바코드</option>
                    </select>
                    <input type="text" 
                           class="search-keyword-input" 
                           id="productSearchKeyword" 
                           placeholder="검색어를 입력하세요">
                    <button class="search-btn" id="productSearchBtn" type="button">검색</button>
                </div>
                <div class="search-result-info">
                    총 <span class="search-result-count" id="productSearchCount">0</span>개의 상품
                </div>
            </div>
            
            <div class="product-image-grid" id="productImageGrid">
                <div class="empty-result" style="grid-column: 1 / -1;">
                    <h3>검색어를 입력해주세요</h3>
                    <p>상품명 또는 바코드로 검색할 수 있습니다.</p>
                </div>
            </div>
        </div>

        <!-- 템플릿 레이아웃 / 카테고리 / 소스 필터 영역 -->
        <div class="template-container" id="templateContainer">
        <div class="sidebar-search">
            <div class="search-box">
                <!-- 템플릿 타입: 공통 / 우리 마트 -->
                <select class="search-select" id="templateSource"
                        onchange="PopEditor.filterTemplateByLayout()">
                    <option value="COMMON" selected>공통 템플릿</option>
                    <option value="MY">우리 마트 템플릿</option>
                </select>

                <!-- 레이아웃 선택: 전체 / 세로형 / 가로형 / 쇼카드 -->
                <select class="search-select" id="templateLayout"
                        onchange="PopEditor.filterTemplateByLayout()">
                    <option value="">전체 레이아웃</option>
                    <option value="VERTICAL">세로형</option>
                    <option value="HORIZONTAL">가로형</option>
                    <option value="SHOWCARD">쇼카드</option>
                </select>

                <!-- 카테고리 선택: 동적으로 로드 -->
                <select class="search-select" id="templateCategory"
                        onchange="PopEditor.filterTemplateByLayout()">
                    <option value="">전체 카테고리</option>
                    <!-- 카테고리는 JavaScript로 동적 로드됨 -->
                </select>
            </div>

            <div style="margin-top: 6px; font-size: 16px; color:#666;">
                전체 템플릿
                <strong id="templateTotalCount" style="color:#667eea;" th:text="${templateTotalCount}">0</strong> 개
            </div>
        </div>

        <!-- 템플릿 리스트 -->
        <div class="template-list" id="templateList">
            <div class="template-category">
                <div class="category-header">
                    <div>
                        <span class="category-title">
                            📁
                            <span id="currentSourceLabel">공통 템플릿</span>
                            ·
                            <span id="currentLayoutLabel">전체 레이아웃</span>
                            /
                            <span id="currentCategoryLabel">전체 카테고리</span>
                        </span>
                    </div>
                </div>

                <div class="template-grid">
                    <div class="template-item"
                         th:each="tpl : ${templateList}"
                         th:attr="
                           data-template-id=${tpl.tplId},
                           data-tpl-seq=${tpl.tplSeq},
                           data-bg=${tpl.bgImgUrl},
                           data-layout=${tpl.layoutType},
                           data-tpl-json=${tpl.tplJson},
                           data-ctgy-big=${tpl.tplCtgyBig},
                           data-ctgy-mid=${tpl.tplCtgyMid},
                           data-ctgy-sml=${tpl.tplCtgySml},
                           data-ctgy-sub=${tpl.tplCtgySub}
                         ">
                        <div class="template-thumb">
                            <!-- 썸네일이 있으면 썸네일 사용, 없으면 배경 이미지 사용 -->
                            <img th:src="${tpl.thumbnailUrl != null && !#strings.isEmpty(tpl.thumbnailUrl) ? tpl.thumbnailUrl : tpl.bgImgUrl}"
                                 alt="템플릿"/>
                            
                            <!-- 삭제 버튼: a4 관리자는 모든 템플릿, 일반 마트는 자신의 우리매장 템플릿만 -->
                            <button class="delete-template-btn" 
                                    type="button"
                                    value="DELETE"
                                    th:if="${(user != null and user.id == 'a4') or (user != null and tpl.isCommon == 'N' and tpl.martCd == user.id)}"
                                    th:attr="data-tpl-seq=${tpl.tplSeq}, data-tpl-nm=${tpl.tplNm}"
                                    onclick="deleteTemplate(event, this.dataset.tplSeq, this.dataset.tplNm)"
                                    title="템플릿 삭제">
                                ❌
                            </button>
                        </div>
                        <div class="template-name" th:text="${tpl.tplNm}">샘플 템플릿</div>
                        <div class="template-size"></div>
                    </div>

                    <!-- 조회 결과 없을 때 -->
                    <div class="template-item" th:if="${#lists.isEmpty(templateList)}">
                        <div class="template-thumb">템플릿 없음</div>
                        <div class="template-name">조건에 해당하는 템플릿이 없습니다.</div>
                        <div class="template-size"></div>
                    </div>
                </div>

                <!-- 페이징 영역 -->
                <div class="template-pagination" style="margin-top:8px; display:flex; align-items:center; gap:8px;">
                    <button type="button" id="tplPrevPage" class="toolbar-btn">이전</button>
                    <span id="tplPageInfo" style="font-size:14px; color:#555;">1 / 1 페이지</span>
                    <button type="button" id="tplNextPage" class="toolbar-btn">다음</button>
                </div>
            </div>
        </div>
        </div>
    </aside>

    <!-- 가운데: 편집 캔버스 -->
    <section class="canvas-area">
        <div class="canvas-wrapper">
            <canvas id="editCanvas" width="800" height="600"></canvas>

            <div class="empty-canvas-message">
                <h3>POP 작업을 시작하세요</h3>
                <p>좌측 템플릿을 선택하거나 툴바에서 텍스트/도형/이미지를 추가해보세요.</p>
            </div>
        </div>
    </section>

    <!-- 오른쪽: 미리보기 -->
    <aside class="right-preview">
        <div class="preview-box">
            <div class="preview-header-wrapper">
                <div class="preview-title">미리보기</div>
                <button class="print-btn" type="button" onclick="PopEditor.printPreview()" title="템플릿 인쇄">
                🖨️ 인쇄
                </button>
            </div>
            <p class="preview-info">왼쪽 캔버스를 수정하면, 이 영역에 축소본으로 표시됩니다.</p>
            <div id="previewContainer">
                <canvas id="previewCanvas" width="800" height="600"></canvas>
            </div>
        </div>
    </aside>

</div>

<div id="previewZoomModal" class="preview-zoom-modal" aria-hidden="true">
    <div class="preview-zoom-overlay"></div>
    <div class="preview-zoom-content" role="dialog" aria-modal="true">
        <canvas id="previewZoomCanvas"></canvas>
    </div>
</div>
<!-- 저장 모달 -->
<div id="saveModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>템플릿 저장</h3>
            <button type="button" class="modal-close" onclick="PopEditor.closeSaveModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="modal-row">
                <label for="saveTplNm">템플릿명 <span class="required">*</span></label>
                <input type="text" id="saveTplNm" placeholder="예) 겨울 행사 POP" />
            </div>
            <div class="modal-row">
                <label for="saveCtgyBig">카테고리(대) <span class="required">*</span></label>
                <input type="text" id="saveCtgyBig" placeholder="예) 봄, 명절, 생선, 가을" />
            </div>
            <div class="modal-row">
                <label for="saveLayoutType">레이아웃 <span class="required">*</span></label>
                <select id="saveLayoutType">
                    <option value="VERTICAL">세로형</option>
                    <option value="HORIZONTAL">가로형</option>
                    <option value="SHOWCARD">쇼카드</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn" onclick="PopEditor.closeSaveModal()">취소</button>
            <button type="button" class="btn primary" onclick="PopEditor.confirmSave()">저장</button>
        </div>
    </div>
</div>

<!-- Fabric.js v6.9.0 로드 -->
<script src="https://cdn.jsdelivr.net/npm/fabric@6.9.0/dist/index.js"></script>
<!-- POP 에디터 스크립트 -->
<script th:src="@{/js/popEditor.js}"></script>
<!-- 상품 이미지 검색 스크립트 -->
<script th:src="@{/js/productSearch.js}"></script>

<script>
    function logout() {
        if (confirm('로그아웃 하시겠습니까?')) {
            window.location.href = '/logout';
        }
    }

    // 템플릿 삭제 함수
    async function deleteTemplate(event, tplSeq, tplNm) {
        // 이벤트 버블링 방지 (클릭 시 템플릿 로드 방지)
        event.stopPropagation();

        if (!confirm(`"${tplNm}" 템플릿을 정말 삭제하시겠습니까?\n\n삭제된 템플릿은 복구할 수 없습니다.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/templates/${tplSeq}`, {
                method: 'DELETE'
            });

            const data = await response.json().catch(() => ({}));

            if (!response.ok || !data.success) {
                const errorMsg = data.message || '삭제에 실패했습니다.';
                alert('오류: ' + errorMsg);
                return;
            }

            alert(`"${tplNm}" 템플릿이 삭제되었습니다.`);

            // 템플릿 목록 재로드
            if (typeof PopEditor !== 'undefined' && PopEditor.filterTemplateByLayout) {
                PopEditor.filterTemplateByLayout();
            } else {
                location.reload();
            }

        } catch (error) {
            console.error('삭제 중 오류:', error);
            alert('삭제 중 오류가 발생했습니다.');
        }
    }

    // 페이지 로드 시 카테고리 목록 불러오기
    async function loadCategories() {
        try {
            const response = await fetch('/api/templates/categories');
            const data = await response.json();

            if (data.success && data.categories && data.categories.length > 0) {
                const categorySelect = document.getElementById('templateCategory');

                // 기존 옵션 유지 (전체 카테고리)
                const currentValue = categorySelect.value;

                // 기존 옵션 제거 (첫 번째 '전체 카테고리' 제외)
                while (categorySelect.options.length > 1) {
                    categorySelect.remove(1);
                }

                // 새 카테고리 추가
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });

                // 이전 선택값 복원
                if (currentValue) {
                    categorySelect.value = currentValue;
                }

                console.log(`카테고리 ${data.categories.length}개 로드 완료`);
            }
        } catch (error) {
            console.error('카테고리 로드 실패:', error);
        }
    }

    // 사이드바 탭 전환
    function toggleSidebarTab(type) {
        const templateContainer = document.getElementById('templateContainer');
        const productContainer = document.getElementById('productSearchContainer');
        const tabs = document.querySelectorAll('.sidebar-tab');
        
        // 탭 활성화 상태 변경
        tabs.forEach(tab => tab.classList.remove('active'));
        
        if (type === 'template') {
            templateContainer.classList.remove('hidden');
            productContainer.classList.remove('active');
            tabs[0].classList.add('active');
        } else if (type === 'product') {
            templateContainer.classList.add('hidden');
            productContainer.classList.add('active');
            tabs[1].classList.add('active');
        }
    }

    // 페이지 로드 시 카테고리 불러오기
    window.addEventListener('DOMContentLoaded', function() {
        loadCategories();
    });
</script>
</body>
</html>
